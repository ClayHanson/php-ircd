<?php
	if ($x = @socket_accept($sock))
	{
		/* if (sizeof($conn) == MAX_USERS) {
			socket_write($x, 'Server full. Closing down.');
		}
		else
		{ */
			$conn[] = array(
				'nick'    => null,
				'sock'    => $x,
				'buf'     => '',
				'ip'      => 0,
				);
			socket_set_nonblock($x);
			send($x, ':' . $config['name'] . ' NOTICE AUTH :*** Looking up your hostname...');//.$config['name']);
			send($x, ':' . $config['name'] . ' NOTICE AUTH :*** Found your hostname');
		//}
	}

	foreach($conn as $me)
	{
		while (false != $c = trim(socket_normal_read($me['sock'])))
		{
			echo '<<< ' . $c . "\n";
			$args = explode(' ', $c);
			switch (strtolower($args[0]))
			{
case 'nick':
	$me['nick'] = $args[1];
	send($me['sock'], ':' . $config['name'] . ' 001 ' . $args[1] . ' :Welcome to the DevNet IRC Network ' . $args[1] . '!a@localhost');
	send($me['sock'], ':' . $config['name'] . ' 002 ' . $args[1] . ' :Your host is ' . $config['name'] . ', running version Unreal3.2.7');
	send($me['sock'], ':' . $config['name'] . ' 003 ' . $args[1] . ' :This server was created Fri Jul 13 19:22:25 2007');
	send($me['sock'], ':' . $config['name'] . ' 004 ' . $args[1] . ' ' . $config['name'] . ' Unreal3.2.7 iowghraAsORTVSxNCWqBzvdHtGp lvhopsmntikrRcaqOALQbSeIKVfMCuzNTGj');
	send($me['sock'], ':' . $config['name'] . ' 005 ' . $args[1] . ' CMDS=KNOCK,MAP,DCCALLOW,USERIP NAMESX SAFELIST HCN MAXCHANNELS=10 CHANLIMIT=#:10 MAXLIST=b:60,e:60,I:60 NICKLEN=30 CHANNELLEN=32 TOPICLEN=307 KICKLEN=307 AWAYLEN=307 MAXTARGETS=20 :are supported by this server');
	send($me['sock'], ':' . $config['name'] . ' 005 ' . $args[1] . ' WALLCHOPS WATCH=128 SILENCE=15 MODES=12 CHANTYPES=# PREFIX=(qaohv)~&@%+ CHANMODES=beI,kfL,lj,psmntirRcOAQKVCuzNSMTG NETWORK=DevNet CASEMAPPING=ascii EXTBAN=~,cqnr ELIST=MNUCT STATUSMSG=~&@%+ EXCEPTS :are supported by this server');
	send($me['sock'], ':' . $config['name'] . ' 005 ' . $args[1] . ' INVEX :are supported by this server');
	send($me['sock'], ':' . $config['name'] . ' 251 ' . $args[1] . ' :There are ' . (sizeof($conn) + 1) . ' users and 1 invisible on 1 servers');
	send($me['sock'], ':' . $config['name'] . ' 252 ' . $args[1] . ' 1 :operator(s) online');
	send($me['sock'], ':' . $config['name'] . ' 254 ' . $args[1] . ' ' . sizeof($channels) . ' :channels formed');
	send($me['sock'], ':' . $config['name'] . ' 255 ' . $args[1] . ' :I have ' . sizeof($conn) . ' clients and 0 servers');
	send($me['sock'], ':' . $config['name'] . ' 265 ' . $args[1] . ' :Current Local Users: ' . sizeof($conn) . '  Max: ' . sizeof($conn));
	send($me['sock'], ':' . $config['name'] . ' 266 ' . $args[1] . ' :Current Global Users: ' . sizeof($conn) . '  Max: ' . sizeof($conn));
	send($me['sock'], ':' . $config['name'] . ' 422 ' . $args[1] . ' :MOTD File is missing');
	break;

case 'privmsg':
	$target = $args[1];
	$message = substr($c, strpos($c, ' :') + 2);
	if(isset($channels[strtolower($target)]))
	{
		foreach($channels[strtolower($target)] as $user)
		{
		if (!($user == $me))
			send($user['sock'], ':' . $me['nick'] . '!a@localhost PRIVMSG ' . $target . ' :' . $message);
		}
	}
	else
	{
		foreach($conn as $him)
		{
			if(strtolower($me2['nick']) == strtolower($target))
				send($me2['sock'], ':' . $me['nick'] . '!a@localhost PRIVMSG ' . $target . ' :' . $message);
		}
	}
	break;

case 'notice':
	$target = $args[1];
	$message = substr($c, strpos($c, ' :') + 2);
	if(isset($channels[strtolower($target)]))
	{
		foreach($channels[strtolower($target)] as $user)
		{
		if (!($user == $me))
			send($user['sock'], ':' . $me['nick'] . '!a@localhost NOTICE ' . $target . ' :' . $message);
		}
	}
	else
	{
		foreach($conn as $him)
		{
			if(strtolower($me2['nick']) == strtolower($target))
				send($me2['sock'], ':' . $me['nick'] . '!a@localhost NOTICE ' . $target . ' :' . $message);
		}
	}
	break;

case 'join':
	$target = $args[1];
	$names = $me['nick'];
	if(isset($channels[strtolower($target)]))
	{
		if(in_array($me,$channels[strtolower($target)]))
			break;

		foreach($channels[strtolower($target)] as $user)
		{
			send($user['sock'], ':' . $me['nick'] . '!a@localhost JOIN ' . $target);
			$names .= ' ' . $user['nick'];
		}
	}
	else
	{
		$channels[strtolower($target)] = array();
	}
	$channels[strtolower($target)][] = $me;
	send($me['sock'], ':' . $me['nick'] . '!a@localhost JOIN ' . $target);
	send($me['sock'], ':' . $config['name'] . ' 353 ' . $me['nick'] . ' = ' . $target . ' :~ChanServ ' . $names);
	send($me['sock'], ':' . $config['name'] . ' 366 ' . $me['nick'] . ' ' . $target . ' :End of /NAMES list.');
	break;

case 'part':
	$target = $args[1];
	$message = '';
	if (strpos($c, ' :') !== false)
		$message = substr($c, strpos($c, ' :'));

	if(isset($channels[strtolower($target)]))
	{
		if(!in_array($me,$channels[strtolower($target)]))
			break;

		foreach($channels[strtolower($target)] as $user)
		{
			send($user['sock'], ':' . $me['nick'] . '!a@localhost PART ' . $target . $message);
		}
	}
	else
	{
		break;
	}

	array_removal($me, $channels[strtolower($target)]);
	send($me['sock'], ':' . $me['nick'] . '!a@localhost PART ' . $target . $message);
	break;

case 'names':
	$target = $args[1];
	$names = '~ChanServ';
	if(isset($channels[strtolower($target)]))
	{
		foreach($channels[strtolower($target)] as $user)
		{
			$names .= ' ' . $user['nick'];
		}
	}

	send($me['sock'], ':' . $config['name'] . ' 353 ' . $me['nick'] . ' = ' . $target . ' :' . $names);
	send($me['sock'], ':' . $config['name'] . ' 366 ' . $me['nick'] . ' ' . $target . ' :End of /NAMES list.');
	break;

case 'ping':
	if (strpos($args[1], ':') === false)
		$args[1] = ':' . $args[1];

	send($me['sock'], ':' . $config['name'] . ' PONG ' . $config['name'] . ' ' . $args[1]);
	break;

			}
		}
	}
	sleep(1);
?>

