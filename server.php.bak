<?php
// MonoNet protocol version 0.1 server
// written and copyright 2008 Nick Markwell (RcokerMONO/duck)
// feel free to edit and distribute as long as you leave my original credit for this


$config=Array();
$config['name']="homebrew.danopia.no-ip.org";
$config['maxLen']=512;
$config['port']=7000;
$config['line_ending']="\n";

$sockets = array();
$channels = array();
$queues = array();
$sock_num = 0;

function socket_normal_read($socket)
{
	global $config, $sockets, $queues, $sock_num;
	for ($i = 0; isset ($sockets[$i]) && $socket != $sockets[$i]; $i++);

	if (!isset ($sockets[$i])) {
		$sockets [$sock_num] = $socket;
		$queues [$sock_num++] = "";
	}

	$recv = socket_read ($socket, $config['maxLen']);
//$recv = str_replace($recv, "\r", "");
	if ($recv === "") {
		if (strpos ($queues[$i], $config['line_ending']) === false)
			return false;
	}
	else if ($recv !== false) {
		$queues[$i] .= $recv;
	}

	$pos = strpos ($queues[$i], $config['line_ending']);
	if ($pos === false)
		return "";
	$ret = substr ($queues[$i], 0, $pos);
	$queues[$i] = substr ($queues[$i], $pos+1);

	return $ret;
}

function array_removal($val, &$arr)
{
	$i = array_search($val,$arr);
	if($i == false) return false;
	$arr = array_merge(array_slice($arr, 0, $i), array_slice($arr, $i + 1));
	return true;
}

error_reporting(E_ERROR | E_PARSE);
//error_reporting(E_ALL);

set_time_limit(0);

$version = 0.0;
$verStr = (string)$version;
if(!stristr($verStr,".")){
	$version=number_format($version,1);
	$verStr=(string)$version;
}

define('SERVER_PORT',	$config['port']);
define('MAX_USERS',	10);

$sock = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);
socket_bind($sock, '0.0.0.0', SERVER_PORT);
echo socket_strerror(socket_last_error());
socket_listen($sock, MAX_USERS);
$conn = array();

socket_set_nonblock($sock);

//file_put_contents("status.txt","up");

while (true) {
	include("connection_handler.php");
}

function send($socket,$text){
	socket_write($socket,$text."\r\n");
echo '>>> ' . $text."\r\n";
}

?>
